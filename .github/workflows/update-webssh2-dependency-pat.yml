name: Update webssh2 dependency (PAT version)

on: {}
  # release:
  #   types: [published]
  # push:
  #   branches:
  #     - main
  #   paths:
  #     - 'package.json'
  # workflow_dispatch:

jobs:
  update-dependency:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout webssh2_client
        uses: actions/checkout@v5

      - name: Get webssh2_client version
        id: get-version
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Using webssh2_client version: $VERSION"

      - name: Checkout webssh2
        uses: actions/checkout@v5
        with:
          repository: billchurch/webssh2
          token: ${{ secrets.WEBSSH2_UPDATE_PAT }}  # Need to create this PAT
          path: webssh2

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Update webssh2 dependency
        working-directory: webssh2
        run: |
          # Get current version
          CURRENT_VERSION=$(node -p "require('./package.json').dependencies.webssh2_client || 'none'")
          NEW_VERSION="^${{ steps.get-version.outputs.version }}"
          
          echo "Current webssh2_client version: $CURRENT_VERSION"
          echo "New webssh2_client version: $NEW_VERSION"
          
          if [ "$CURRENT_VERSION" = "$NEW_VERSION" ]; then
            echo "Version already up to date"
            echo "skip=true" >> $GITHUB_ENV
          else
            # Update the dependency
            npm pkg set dependencies.webssh2_client="$NEW_VERSION"
            npm install
            echo "skip=false" >> $GITHUB_ENV
          fi

      - name: Create Pull Request
        if: env.skip != 'true'
        uses: peter-evans/create-pull-request@v7
        with:
          path: webssh2
          token: ${{ secrets.WEBSSH2_UPDATE_PAT }}
          sign-commits: true
          commit-message: 'chore: update webssh2_client to v${{ steps.get-version.outputs.version }}'
          branch: auto-update/webssh2-client-${{ steps.get-version.outputs.version }}
          delete-branch: true
          title: 'chore: update webssh2_client to v${{ steps.get-version.outputs.version }}'
          body: |
            ## 🔄 Automated Dependency Update
            
            Updates `webssh2_client` to version **${{ steps.get-version.outputs.version }}**
            
            ### Trigger
            - ${{ github.event_name == 'release' && '🎉 New release published' || github.event_name == 'push' && '📝 Package.json updated' || '🔧 Manual workflow dispatch' }}
            - Source: ${{ github.repository }}@${{ github.sha }}
            
            ### Changes
            - ✅ Updated `webssh2_client` in package.json
            - ✅ Updated package-lock.json
            
            ### Next Steps
            1. Review the changes
            2. Run tests to ensure compatibility
            3. Merge if everything looks good
            
            ---
            *🤖 This PR was automatically created by the webssh2_client update workflow*
          labels: |
            dependencies
            automated
            webssh2_client