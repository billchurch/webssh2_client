name: Update webssh2 dependency

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to update to (leave empty to use latest)'
        required: false
        type: string

jobs:
  update-dependency:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout webssh2_client
        uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5
        with:
          repository: billchurch/webssh2_client
          path: webssh2_client

      - name: Checkout webssh2
        uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5
        with:
          repository: billchurch/webssh2
          token: ${{ secrets.GITHUB_TOKEN }}
          path: webssh2

      - name: Setup Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4
        with:
          node-version: '22'

      - name: Get webssh2_client version
        id: get-version
        run: |
          if [ "${{ github.event_name }}" = "release" ]; then
            VERSION="${{ github.event.release.tag_name }}"
            VERSION="${VERSION#v}"  # Remove 'v' prefix if present
          elif [ -n "${{ github.event.inputs.version }}" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            # Get the latest version from npm
            cd webssh2_client
            VERSION=$(node -p "require('./package.json').version")
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Using webssh2_client version: $VERSION"

      - name: Update webssh2 package.json
        working-directory: webssh2
        run: |
          # Update the webssh2_client dependency version
          npm pkg set dependencies.webssh2_client="^${{ steps.get-version.outputs.version }}"
          
          # Run npm install to update package-lock.json
          npm install

      - name: Check for changes
        id: check-changes
        working-directory: webssh2
        run: |
          if git diff --quiet package.json package-lock.json; then
            echo "No changes detected"
            echo "has-changes=false" >> $GITHUB_OUTPUT
          else
            echo "Changes detected"
            echo "has-changes=true" >> $GITHUB_OUTPUT
            git diff package.json
          fi

      - name: Create Pull Request
        if: steps.check-changes.outputs.has-changes == 'true'
        uses: peter-evans/create-pull-request@84ae59a2cdc2258d6fa0732dd66352dddae2a412 # v7
        with:
          path: webssh2
          token: ${{ secrets.GITHUB_TOKEN }}
          sign-commits: true
          commit-message: |
            chore: update webssh2_client to v${{ steps.get-version.outputs.version }}
            
            Updates webssh2_client dependency to version ${{ steps.get-version.outputs.version }}
          branch: update-webssh2-client-${{ steps.get-version.outputs.version }}
          delete-branch: true
          title: 'chore: update webssh2_client to v${{ steps.get-version.outputs.version }}'
          body: |
            ## ðŸ”„ Dependency Update
            
            This PR updates the `webssh2_client` dependency to version **${{ steps.get-version.outputs.version }}**.
            
            ### Changes
            - Updated `webssh2_client` in package.json
            - Updated package-lock.json
            
            ### Release Notes
            ${{ github.event_name == 'release' && github.event.release.body || 'Manual update triggered via workflow dispatch.' }}
            
            ---
            *This PR was automatically created by the update-webssh2-dependency workflow.*
          labels: |
            dependencies
            automated
          assignees: billchurch